# 히스토리 비대화 분석과 재작성 제안

## 1. 조사 개요
- 대상 저장소: `C:\Users\Gi\Desktop\Urwebs`
- 사용 명령:
  - `git rev-list --objects --all | git cat-file --batch-check='%(objecttype) %(objectname) %(objectsize) %(rest)' | sort -k3 -nr | head`
  - `git count-objects -v`
- 목표: 과거 커밋에 남아 있는 대용량 객체(바이너리/폴더 패턴) 파악 및 히스토리 재작성 필요성 평가
- 현재 저장소 팩 파일 크기: 약 389 kB (`git count-objects -v`) → 전체 용량 자체는 크지 않으나, 반복적으로 큰 텍스트 파일이 누적된 패턴을 확인

## 2. 대형 객체 패턴 (상위 200 kB 이상)
| 순위 | 객체 크기 | 경로 | 발생 빈도 추정 | 설명 |
| --- | --- | --- | --- | --- |
| 1 | 315 kB~311 kB | `package-lock.json` | 수차례 | 잠금 파일이 커밋마다 완전 교체되어 누적. 텍스트이지만 잦은 전체 diff로 히스토리 부피 증가 |
| 2 | 258 kB~220 kB | `src/components/MyPage.tsx` | 수십 회 | 대형 React 컴포넌트. 기능 추가/리팩터 과정에서 파일 전체가 크게 변동되며 반복 커밋 |
| 3 | 228 kB | `src/components/MyPage.tsx.backup` | 1회 | 백업 용도로 보관된 추정 파일. 현재 워킹 트리에는 존재하지 않으나 히스토리에 남아 있음 |
| 4 | 200 kB 전후 | `src/components/CategoryDetailPage.tsx`, `CategoryDetailPageColumns.tsx` 등 | 다수 | 과거 홈/카테고리 페이지 리뉴얼 당시의 대형 UI 모듈. 최신 커밋에서는 분할/삭제됐으나 기록 잔존 |
| 5 | 190 kB 이하 | 과거 `CustomStartPage*.tsx`, `TemplateEditPage.tsx` 등 | 일부 | 옛 버전의 템플릿/위젯 관련 페이지. 현재 구조와 다를 수 있음 |

> 대용량 바이너리(영상, PSD 등)는 발견되지 않았으며, 대부분이 TypeScript/JSON 텍스트 파일입니다.

## 3. 히스토리 재작성 도구 선택과 영향 분석
| 구분 | BFG Repo-Cleaner | `git filter-repo` |
| --- | --- | --- |
| 장점 | 특정 경로/패턴 제거가 매우 빠름 | 파이프라인화·스크립트화 용이, 미세 제어 가능 |
| 단점/제약 | 세밀한 히스토리 변환 옵션 부족, 텍스트 치환 시 주의 필요 | Python 설치 필요, 실행 시간이 BFG보다 다소 길 수 있음 |
| 공통 영향 | - 모든 커밋 SHA 변경 (포크·오픈 PR·서브모듈·태그에 영향) <br> - 재작성 브랜치와 기존 브랜치 사이 히스토리 단절 <br> - 원격 `force-push` 필요 |
| 포크 영향 | 포크 레포는 각각 수동으로 `git fetch --all` 후 강제 리셋 필요. 협업 중인 포크 수가 많다면 조율 시간 필요 |
| 오픈 PR 영향 | GitHub PR은 원본 커밋 SHA 변경 시 자동으로 히스토리 충돌. PR 작성자에게 rebase/force-push 요청 필요 |
| 서브모듈 영향 | 현재 저장소가 타 저장소의 서브모듈로 쓰이는 경우, 상위 저장소에서도 서브모듈 커밋 업데이트 필수 |
| 태그 영향 | 릴리스 태그는 모두 무효화되어 재작성 후 동일 포인트에 재부여해야 함 |

## 4. 제안: 재작성 추진 절차 (승인 후 별도 브랜치에서 수행)
1. **사전 준비**
   - 오너/팀 동의 및 영향 범위 공지 (포크 수, 오픈 PR 리스트, 태그 현황).
   - 정리 대상 경로 확정: 예) `package-lock.json` 과거 버전 전체 제거 vs 최근 N개 유지, `src/components/MyPage.tsx.backup` 완전 삭제 등.
   - 백업: 원격/로컬 모두 전체 백업(`git clone --mirror`) 생성.
2. **작업 전용 브랜치 생성**
   - `git checkout --orphan history-cleanup`
   - 원본을 보호하기 위해 별도 원격(예: `origin-cleanup`) 사용 권장.
3. **도구 실행 (예시)**
   - BFG: `java -jar bfg.jar --delete-files package-lock.json --protect-blobs-from HEAD~50`
   - 또는 `git filter-repo`: `git filter-repo --path src/components/MyPage.tsx.backup --invert-paths`
   - 대체 전략: `git filter-repo --strip-blobs-bigger-than 200K --protect-blobs-from refs/heads/main`
4. **결과 검증**
   - `git fsck`, `git log` 확인.
   - 제거 대상 파일이 최신 커밋에서 필요한 경우 복원 여부 점검.
5. **리모트 반영**
   - 준비된 새 원격에 `--force` 푸시하여 리뷰 공유(예: `origin-cleanup/history-cleanup`).
   - 팀과 함께 이 브랜치를 기준으로 최종 승인 여부 결정.

## 5. 재작성 후 체크리스트
1. **강제 푸시 & 브랜치 관리**
   - 메인 브랜치(`main`/`develop`)에 `--force-with-lease`로 푸시.
   - 보호 브랜치 설정을 일시 해제해야 할 수 있으므로 관리자 승인 필요.
2. **팀 동기화 절차**
   - 전 구성원에게 `git fetch --all --prune` 후 `git reset --hard origin/main` 안내.
   - 로컬 브랜치/PR은 `git rebase --onto` 또는 새로 생성하도록 가이드.
3. **태그/릴리스 복원**
   - 삭제된 태그는 새 커밋 SHA에 맞춰 재생성 (`git tag -d`, `git tag`, `git push --tags --force`).
4. **CI/CD 및 캐시 리셋**
   - 빌드 캐시(예: Vercel, Netlify, GitHub Actions 캐시) 초기화.
   - Docker/Image registry, CDN 등 캐시된 리비전이 있다면 무효화.
5. **백업 및 롤백 플랜**
   - 재작성 전 `git clone --mirror` 본문 백업 유지.
   - 문제 발생 시 백업 리모트를 `git push --mirror`로 복구 가능.
   - 정리된 브랜치 문제 발견 시 즉시 백업으로 환원하고 원인 분석 후 2차 시도.

## 6. 권장 방안 요약
- **이 단계에서는 히스토리 재작성 미실행.** 팀 합의 후 별도 브랜치에서만 수행.
- 우선순위 정리:
  1. `MyPage.tsx`와 같이 지속적으로 커지는 파일 구조 분할/모듈화 → 향후 커밋의 대형 diff 방지.
  2. 필요 없는 백업/스냅샷 파일(`*.backup`)은 워킹 트리에서 제거 후 새로운 커밋으로 정리.
  3. 잠금 파일은 반드시 포함되어야 하므로 재작성 시 “최신 버전만 유지” 여부를 신중히 결정.
- 히스토리 재작성 전, 현재 용량이 실제 문제인지(클론 속도, CI 다운로드 시간 등) 지표 확보 권장.

## 7. 롤백 플랜
| 상황 | 대응 |
| --- | --- |
| 재작성 브랜치 문제 발견 | 백업 미러에서 `git push --mirror`로 원상 복구 |
| 팀원이 기존 커밋을 기반으로 작업 후 충돌 | `git rebase --onto` 가이드 제공 또는 `git cherry-pick`으로 수동 이식 |
| CI/CD가 오래된 SHA를 참조 | 빌드 파이프라인에서 캐시 무시 옵션 활성화 (`--no-cache`, `cache: purge`) |

---  
**결론:** 현재 히스토리는 대형 텍스트 파일(특히 `MyPage.tsx`, `package-lock.json`)이 반복적으로 누적된 것이 주 원인입니다. 바이너리 삭제 필요성은 낮지만, 향후 유지보수 편의성과 향후 커밋 크기 관리를 위해 구조 분할·백업 파일 제거를 우선 시행하고, 히스토리 재작성은 팀 합의 후 별도 브랜치에서 검증 절차를 거쳐 진행하는 것을 권장합니다.

